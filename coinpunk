coinpunk.controllers.Accounts=function(){},coinpunk.controllers.Accounts.prototype=new coinpunk.Controller,coinpunk.controllers.Accounts.prototype.requiredPasswordLength=10,coinpunk.controllers.Accounts.prototype.passwordStrength={enabled:!1,enable:function(){this.enabled!==!0&&(this.enabled=!0,$.strength("#email","#password",function(a,b,c){$("#progressBar").css("width",c.score+"%");var d=c.status.charAt(0).toUpperCase()+c.status.slice(1);$("#passwordStrengthStatus").text(d)}))}},coinpunk.controllers.Accounts.prototype.signin=function(){var a=$("#walletId").val(),b=$("#password").val(),c=$("#errors");c.addClass("hidden"),c.html("");var d=new coinpunk.Wallet,e=(d.createWalletKey(a,b),d.encryptPayload(),{serverKey:d.serverKey}),f=$("#authCode");f&&(e.authCode=f.val()),$.get("/api/wallet",e,function(a){"error"==a.result?(c.removeClass("hidden"),c.text(a.message)):"authCodeNeeded"==a.result?(c.removeClass("hidden"),c.text(a.message),$("#signinPassword").after('\n        <div class="form-group">\n          <label for="authCode" class="col-lg-2 control-label">Auth Code</label>\n          <div class="col-lg-4">\n            <input id="authCode" type="password" class="form-control" placeholder="">\n          </div>\n        </div>\n      '),$("#authCode").focus(),coinpunk.usingAuthKey=!0):(c.addClass("hidden"),d.loadPayload(a.wallet),d.sessionKey=a.sessionKey,coinpunk.wallet=d,coinpunk.router.listener(),coinpunk.router.route("dashboard"))})},coinpunk.controllers.Accounts.prototype.disableSubmitButton=function(){var a=$("#createAccountButton");a.attr("disabled","disabled"),a.removeClass("btn-success"),a.text("Creating account, please wait..")},coinpunk.controllers.Accounts.prototype.enableSubmitButton=function(){var a=$("#createAccountButton");a.removeAttr("disabled"),a.addClass("btn-success"),a.html('<i class="fa fa-user"></i> Create Account')},coinpunk.controllers.Accounts.prototype.create=function(){var a=this,b=$("#email").val(),c=$("#password").val(),d=$("#password_confirm").val(),e=[];null===/.+@.+\..+/.exec(b)&&e.push("999Email is not valid!.!..."),""===c&&e.push("Password cannot be blank."),c!=d&&e.push("Passwords do not match."),c.length<this.requiredPasswordLength&&e.push("Password must be at least 10 characters.!!!!!");var f=$("#errors");if(e.length>0){f.html("");for(var g=0;g<e.length;g++)f.html(f.html()+coinpunk.utils.stripTags(e[g])+"<br>");$("#errors").removeClass("hidden")}else{$("#errors").addClass("hidden"),this.disableSubmitButton();var h=new coinpunk.Wallet;f.html(h.toString()),$("#errors").removeClass("hidden");var i=h.createNewAddress("Default");e.push(i);var j=h.createWalletKey(b,c);e.push(j),coinpunk.wallet=h,this.saveWallet({address:i,payload:{email:b}},function(b){if("ok"==b.result)coinpunk.wallet.sessionKey=b.sessionKey,coinpunk.router.listener(),coinpunk.router.route("dashboard");else if("exists"==b.result)delete coinpunk.wallet,f.html('Wallet already exists, perhaps you want to <a href="#/signin">sign in</a> instead?'),f.removeClass("hidden"),a.enableSubmitButton();else{f.html("");for(var c=0;c<b.messages.length;c++)f.html(f.html()+coinpunk.utils.stripTags(b.messages[c])+"<br>");$("#errors").removeClass("hidden"),a.enableSubmitButton()}})}},coinpunk.controllers.Accounts.prototype.performImport=function(a,b){var c=$("#importButton");c.attr("disabled","disabled");var a=$("#importId").val(),b=$("#importPassword").val(),d=$("#importFile").get(0).files[0],e=this,f=new FileReader;f.onload=function(d){var f=new coinpunk.Wallet;try{f.loadPayloadWithLogin(a,b,d.target.result)}catch(g){return $("#importErrorDialog").removeClass("hidden"),$("#importErrorMessage").text("Wallet import failed. Check the credentials and wallet file."),c.removeAttr("disabled"),void 0}if(f.transactions&&f.addresses()){{f.encryptPayload()}coinpunk.wallet=f,e.saveWallet({importAddresses:coinpunk.wallet.addressHashes()},function(a){if("exists"==a.result)return $("#importErrorDialog").removeClass("hidden"),$("#importErrorMessage").text("Cannot import your wallet, because the wallet already exists on this server."),c.removeAttr("disabled"),void 0;var b="Wallet import successful! There will be a delay in viewing your transactions until the server finishes scanning for unspent transactions on your addresses. Please be patient.";coinpunk.database.setSuccessMessage(b),coinpunk.router.route("dashboard")})}else $("#importErrorDialog").removeClass("hidden"),$("#importErrorMessage").text("Not a valid wallet backup file."),c.removeAttr("disabled")};try{f.readAsText(d)}catch(g){$("#importErrorDialog").removeClass("hidden"),$("#importErrorMessage").text("You must provide a wallet backup file."),c.removeAttr("disabled")}},coinpunk.controllers.Accounts.prototype.changeId=function(){var a=$("#changeEmailNew"),b=$("#changeEmailPassword"),c=a.val(),d=b.val(),e=this;if(null===/.+@.+\..+/.exec(c))return e.changeDialog("danger","999Email is not valid!."),void 0;var f=coinpunk.wallet.walletId,g=coinpunk.wallet.serverKey,h=(coinpunk.wallet.payloadHash,new coinpunk.Wallet);if(h.createWalletKey(f,d),h.serverKey!=coinpunk.wallet.serverKey)return e.changeDialog("danger","The provided password does not match. Please try again."),void 0;coinpunk.wallet.createWalletKey(c,d);var i={originalServerKey:g,wallet:coinpunk.wallet.encryptPayload(),serverKey:coinpunk.wallet.serverKey,email:c,payloadHash:coinpunk.wallet.payloadHash};coinpunk.wallet.sessionKey&&(i.sessionKey=coinpunk.wallet.sessionKey),$.post("api/change",i,function(c){return"ok"!=c.result?e.changeDialog("danger","An unknown error has occured, please try again later."):(e.template("header","header"),a.val(""),b.val(""),e.changeDialog("success","Successfully changed email. You will need to use this to login next time, don't forget it!"),void 0)})},coinpunk.controllers.Accounts.prototype.changePassword=function(){var a=this,b=$("#currentPassword"),c=$("#newPassword"),d=$("#confirmNewPassword"),e=b.val(),f=c.val(),g=d.val();if(f!=g)return this.changeDialog("danger","New passwords do not match."),void 0;if(f<this.requiredPasswordLength)return this.changeDialog("danger","Password must be at least "+this.requiredPasswordLength+" characters."),void 0;var h=new coinpunk.Wallet;if(h.createWalletKey(coinpunk.wallet.walletId,e),h.serverKey!=coinpunk.wallet.serverKey)return b.val(""),this.changeDialog("danger","Current password is not valid, please re-enter."),void 0;var i=coinpunk.wallet.serverKey;coinpunk.wallet.createWalletKey(coinpunk.wallet.walletId,f);var j={originalServerKey:i,wallet:coinpunk.wallet.encryptPayload(),serverKey:coinpunk.wallet.serverKey,payloadHash:coinpunk.wallet.payloadHash};coinpunk.wallet.sessionKey&&(j.sessionKey=coinpunk.wallet.sessionKey),$.post("api/change",j,function(f){return"error"==f.result?(a.changeDialog("danger","Error changing password"),coinpunk.wallet.createWalletKey(coinpunk.wallet.walletId,e),void 0):(a.template("header","header"),b.val(""),c.val(""),d.val(""),a.changeDialog("success","Successfully changed password. You will need to use this to login next time, don't forget it!"),void 0)})},coinpunk.controllers.Accounts.prototype.changeDialog=function(a,b){$("#changeDialog").removeClass("alert-danger"),$("#changeDialog").removeClass("alert-success"),$("#changeDialog").addClass("alert-"+a),$("#changeDialog").removeClass("hidden"),$("#changeMessage").text(b)},$("body").on("click","#generateAuthQR",function(){var a=$("#generateAuthQR");a.addClass("hidden"),$.get("api/generateAuthKey",function(b){a.after('<div id="authQR"></div>');var c=new URI({protocol:"otpauth",hostname:"totp",path:"Chanpunk:"+coinpunk.wallet.walletId});c.setSearch({issuer:"Chanpunk",secret:b.key}),new QRCode(document.getElementById("authQR"),c.toString()),$("#authQR").after('\n      <form role="form" id="submitAuth">\n        <p>Enter code shown on Google Authenticator:</p>\n        <input type="hidden" id="authKeyValue" value="'+b.key+'">\n        <div class="form-group">\n          <label for="confirmAuthCode">Confirm Auth Code</label>\n          <input class="form-control" type="text" id="confirmAuthCode" autocorrect="off" autocomplete="off">\n        </div>\n        <button type="submit" class="btn btn-primary">Confirm</button>\n      </form>\n    '),$("#confirmAuthCode").focus()})}),$("body").on("submit","#submitAuth",function(){var a=$("#submitAuth #confirmAuthCode");$.post("api/setAuthKey",{serverKey:coinpunk.wallet.serverKey,sessionKey:coinpunk.wallet.sessionKey,key:$("#authKeyValue").val(),code:a.val()},function(a){1!=a.set?$("#authKey").text("Code save failed. Please reload and try again."):(coinpunk.usingAuthKey=!0,$("#authKey").text("Successfully saved! You will now need your device to login."))})}),$("body").on("submit","#disableAuth",function(){var a=$("#disableAuthDialog");a.addClass("hidden");var b=$("#disableAuth #disableAuthCode").val();$.post("api/disableAuthKey",{serverKey:coinpunk.wallet.serverKey,sessionKey:coinpunk.wallet.sessionKey,authCode:b},function(b){return"error"==b.result?(a.text(b.message),a.removeClass("hidden"),void 0):(coinpunk.usingAuthKey=!1,coinpunk.database.setSuccessMessage("Two factor authentication has been disabled."),coinpunk.router.route("dashboard","settings"),void 0)})}),coinpunk.controllers.accounts=new coinpunk.controllers.Accounts;